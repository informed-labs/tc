<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ETL - Cloud Functors using tc</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../assets/custom.css">
        <link rel="stylesheet" href="../assets/mdbook-admonish.css">
        <link rel="stylesheet" href=".././mdbook-admonish.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="part-title">Preamble</li><li class="chapter-item "><a href="../about.html">About</a></li><li class="chapter-item "><a href="../installation.html">Installation</a></li><li class="chapter-item affix "><li class="part-title">Examples</li><li class="chapter-item expanded "><a href="../examples/etl.html" class="active">ETL</a></li><li class="chapter-item "><a href="../examples/job-tracker.html">Job Tracker</a></li><li class="chapter-item affix "><li class="part-title">Modules</li><li class="chapter-item "><a href="../modules/compiler.html">Compiler</a></li><li class="chapter-item "><a href="../modules/resolver.html">Resolver</a></li><li class="chapter-item "><a href="../modules/builder.html">Builder</a></li><li class="chapter-item "><a href="../modules/publisher.html">Publisher</a></li><li class="chapter-item "><a href="../modules/deployer.html">Deployer</a></li><li class="chapter-item "><a href="../modules/differ.html">Differ</a></li><li class="chapter-item "><a href="../modules/emulator.html">Emulator</a></li><li class="chapter-item "><a href="../modules/invoker.html">Invoker</a></li><li class="chapter-item "><a href="../modules/releaser.html">Releaser</a></li><li class="chapter-item affix "><li class="part-title">Reference</li><li class="chapter-item "><a href="../reference/specification.html">Specification</a></li><li class="chapter-item "><a href="../reference/components.html">Components</a></li><li class="chapter-item "><a href="../reference/commands.html">Commands</a></li><li class="chapter-item "><a href="../reference/config.html">Config</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Cloud Functors using tc</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/informed-labs/tc" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<p><code>tc</code> is a tool to build, compose, interactively develop and deploy serverless components. The following is an example of developing and creating a basic topology to enhance, transform and load data.</p>
<p>A Basic Example: ETL</p>
<p>Let's call the topology <code>etl</code>. Our requirements are (I'm just making this up):</p>
<ul>
<li>Trigger the topology via a REST API and an Eventbridge event</li>
<li>Create nano functions that do minimal things by decoupling them from their dependencies.</li>
<li>Build a linear flow of the <code>enhancer</code>, <code>transformer</code> and <code>loader</code> functions.</li>
<li>Write the enhancer and transformer functions in <code>Python</code> and loader in <code>Ruby</code> (huh, don't ask me why)</li>
<li>Build and use a <code>transformer</code> ML model (oh, it's 5GB in size and has weird build steps they say)</li>
<li>Deploy and test the entire thing interactively in dev sandboxes and atomically in prod sandboxes</li>
</ul>
<p>Let's get started!</p>
<ol>
<li>
<p>Create a new directory called <code>etl</code> and add a file called topology.yml to it.</p>
</li>
<li>
<p>Add the following to topology.yml in the <code>etl</code> directory</p>
<p>topology.yml</p>
<pre><code class="language-yaml">name: etl
routes:
	etl:
		gateway: api-test
		proxy: '{{namespace}}_enhancer_{{sandbox}}'
		kind: http
		timeout: 10
		async: false
		method: POST
		path: &quot;/api/etl&quot;

</code></pre>
<p>We now have defined a basic topology that exposes an API endpoint to a function or proxy called <code>enhancer</code>. However, we haven't written or built <code>enhancer</code> function. Let's do that in the next step.</p>
</li>
<li>
<p>Create a directory called <code>enhancer</code> in the etl directory. Create a file called handler.py in etl/enhancer directory</p>
<p>etl/enhancer/handler.py</p>
<pre><code class="language-python">	def handler(event, context):
		return {&quot;data&quot;: &quot;enhanced-data&quot;}
</code></pre>
<p>Now this ain't doing much is it ? That's all we need for a function though with some business logic.</p>
<p>Now we may need some libraries (shared etc). Let's go ahead add a pyproject.toml with our dependencies. Since we are using python, the size of the dependencies can increase thus beating the purpose of having a nano function. However, dependencies are inevitable and let's go with it.</p>
</li>
<li>
<p>Now that we added dependencies, we may need to define some additional metadata about the function. This definition is optional if we keep our functions lean with no dependencies. Anyway, let's create a file called <code>function.json</code> and add the following to it.</p>
<pre><code class="language-json">{
	&quot;name&quot;: &quot;enhancer&quot;,
	&quot;description&quot;: &quot;enhance wer data&quot;,
	&quot;runtime&quot;: {
		&quot;lang&quot;: &quot;python3.10&quot;,
		&quot;package_type&quot;: &quot;zip&quot;,
		&quot;handler&quot;: &quot;handler.handler&quot;,
		&quot;layers&quot;: [&quot;etl-enhancer&quot;],
		&quot;extensions&quot;: []
	},
	&quot;tasks&quot;: {
		&quot;build&quot;: &quot;zip lambda.zip handler.py&quot;,
		&quot;clean&quot;: &quot;rm *.zip&quot;
	}
}
</code></pre>
<p>The above definition describes what our <code>enhancer</code> is, how to invoke it etc. Note that we need to specify the layer name for the dependencies. Follow along ...</p>
</li>
<li>
<p>Let's now build the dependencies. At this point, we may want to consider downloading <a href="./installation.html">tc</a> (it's 5MB executable containing 15K lines of magic written in Rust). We need to login to an AWS env (say dev):</p>
<pre><code class="language-sh">tc login -e dev

cd etl
tc build --publish
</code></pre>
<p>The above command builds and publishes the dependencies as a <code>lambda layer</code> to a centralized account (CICD). Now if our dependencies are really bloated, <code>tc build</code> will split the layers into 40MB (x 3) chunks. If we have nested directories (lib/ vendor/ etc), it will merge it. It will also be able to pull private repos, pull AWS assets when needed.</p>
<p>To see if the dependency layer actually got published, run <code>tc build --list</code></p>
<pre><code class="language-sh">name                                      | version | created_date
-------------------------------------------+---------+------------------------------
etl-enhancer                              | 1       | 2024-01-04T17:24:28.363+0000
</code></pre>
<p>Note that the layer only contains the dependencies we added for etl-enhancer, not the enhancer code itself. That gets packed and deployed separately to our sandbox. <em>The reason the layer build and code packing steps are decoupled is because the former is heavy and the latter is leaner</em>.</p>
</li>
<li>
<p>Phew! building dependencies is not straightforward. It has to be built for the right CPU architecture, find shared objects, resolve shared libs, fetch private repositories, autofix incompatible transitive dependencies. That's a lot of complexity to absorb. Incidental complexity you say, eh ?
Anyhow, let's create a sandbox with our &quot;enhanced&quot; code.</p>
<pre><code class="language-sh">tc create -s bob -e dev

2024-01-15T19:57:03.865 Composing topology...
2024-01-15T19:57:04.168 Initializing functor: etl@bob.dev/0.0.1
2024-01-15T19:57:04.431 Creating function etl_enhancer_bob (214 B)
2024-01-15T19:57:04.431 Creating route /api/etl (OK)
</code></pre>
<p>Voila! Our <code>enhancer</code> function is tiny and the bloated dependencies got layered away in the previous step. Dependencies don't change much do they ? Things that move fast ought to be lean.</p>
</li>
<li>
<p>Let's say we modify our code and would like to incrementally update the sandbox.</p>
<p>We can do <code>tc diff -s bob -e dev</code> to see what the diff is between our local edits and the code in our remote lambda function. When satisfied:</p>
<pre><code class="language-sh">cd etl
tc update -s bob -e dev -c enhancer
</code></pre>
</li>
<li>
<p>Well, there are other infrastructure components in a topology and that is something we prefer to isolate from the code. We can scaffold roles and vars json files to an <code>infrastructure</code> directory</p>
<pre><code class="language-sh">tc scaffold --create functions
</code></pre>
<p>The above command will create roles and vars files in infrastructure/tc/etl/{vars, roles}/enhancer.json. We can add any additional env vars, secret uris and other function-specific IAM permissions.</p>
<p>We can incrementally update the vars, roles etc</p>
<pre><code class="language-sh">tc update -s bob -e dev -c roles
tc update -s bob -e dev -c vars
tc update -s bob -e dev -c routes
</code></pre>
</li>
<li>
<p>Now we may need to create an eventbridge event to trigger our enhancer (Remember, that is a requirement). So let's add that to the topology defintiion.</p>
<pre><code class="language-yaml">name: etl
routes:
	etl:
	gateway: api-test
	proxy: '{{namespace}}_enhancer_{{sandbox}}'
	kind: http
	timeout: 10
	async: false
	method: POST
	path: &quot;/api/etl&quot;

events:
	consumes:
		StartETL:
			producer: default
			function: '{{namespace}}_enhancer_{{sandbox}}'

</code></pre>
<p>Now just update the <code>events</code> component</p>
<pre><code class="language-sh">tc update -s bob -e dev -c events
</code></pre>
</li>
<li>
<p>One of the requirements is to build and use a ML model for the transformer.</p>
<pre><code class="language-json">{
	&quot;name&quot;: &quot;transformer&quot;,
	&quot;description&quot;: &quot;tranform your soul&quot;,
	&quot;runtime&quot;: {
		&quot;lang&quot;: &quot;python3.10&quot;,
		&quot;package_type&quot;: &quot;zip&quot;,
		&quot;handler&quot;: &quot;handler.handler&quot;,
		&quot;layers&quot;: [],
		&quot;extensions&quot;: []
	},
	&quot;assets&quot;: {
		&quot;MODEL_PATH&quot;: &quot;/mnt/assets/etl/transformer/1.0/artifacts&quot;,
		&quot;DEPS_PATH&quot;: &quot;/mnt/assets/etl/transformer/deps&quot;
	},
	&quot;tasks&quot;: {
		&quot;build&quot;: &quot;zip lambda.zip handler.py&quot;,
		&quot;clean&quot;: &quot;rm *.zip&quot;
	}
}
</code></pre>
<p>Now building model (primarily using pytorch) is no child's play. Yet, <code>tc build</code> makes it simple</p>
<pre><code class="language-sh">cd transformer
tc build --kind artifacts --publish
</code></pre>
<p>If an <code>assets</code> key in present in <code>function.json</code> file, <code>tc build --kind deps --publish</code> publishes it to EFS. The models and deps are available to the function automagically.</p>
</li>
<li>
<p>Now, let's write our <code>loader</code> function in Ruby. Can <code>tc</code> build it ? Let's see.</p>
<p>Add a Gemfile, a handler (handler.rb or a module) and function.json in loader directory.</p>
<pre><code class="language-json">{
	&quot;name&quot;: &quot;loader&quot;,
	&quot;description&quot;: &quot;load your jiggle wiggle&quot;,
	&quot;runtime&quot;: {
		&quot;lang&quot;: &quot;ruby3.2&quot;,
		&quot;package_type&quot;: &quot;zip&quot;,
		&quot;handler&quot;: &quot;handler.handler&quot;,
		&quot;layers&quot;: [],
		&quot;extensions&quot;: []
	},
	&quot;tasks&quot;: {
		&quot;build&quot;: &quot;zip lambda.zip handler.rb&quot;,
		&quot;clean&quot;: &quot;rm *.zip&quot;
	}
}
</code></pre>
<p>Like we did with python dependencies, we can create a layer and publish it</p>
<pre><code class="language-sh">cd loader
tc build --publish
</code></pre>
<p><code>tc build --list</code> to see if it got published</p>
<pre><code class="language-sh">name                                      | version | created_date
-------------------------------------------+---------+------------------------------
etl-enhancer                              | 1       | 2024-01-04T17:24:28.363+0000
etl-loader                                | 1       | 2024-01-04T18:24:28.363+0000
</code></pre>
</li>
<li>
<p>Let's create the function:</p>
<pre><code>cd etl
tc create -s bob -e dev

2024-01-15T19:57:03.865 Composing topology...
2024-01-15T19:57:04.168 Initializing functor: etl@bob.dev/0.0.1
2024-01-15T19:57:04.431 Creating function etl_enhancer_bob (214 B)
2024-01-15T19:57:04.431 Creating function etl_transformer_bob (10 KiB)
2024-01-15T19:57:04.431 Creating function etl_loader_bob (629 B)
2024-01-15T19:57:04.431 Creating route /api/test (OK)
</code></pre>
</li>
<li>
<p>Perhaps we can now create a flow of data between <code>enhancer</code> and <code>transformer</code> functions. We can define the flow using the AWS stepfunction ASL.</p>
<pre><code class="language-yaml">name: etl
routes:
	etl:
   	gateway: api-test
	proxy: '{{namespace}}_enhancer_{{sandbox}}'
	kind: http
	timeout: 10
	async: false
	method: POST
	path: &quot;/api/etl&quot;

events:
	consumes:
		StartETL:
			producer: default
			function: '{{namespace}}_enhancer_{{sandbox}}'
flow:
	Comment: ETL
	StartAt: enhance
	TimeoutSeconds: 1200
	States:
		enhance:
			Type: Task
			Resource: arn:aws:states:::lambda:invoke
			OutputPath: $.Payload
			InputPath: $
			Parameters:
				FunctionName: '{{namespace}}_enhancer_{{sandbox}}'
				Payload:
					data.$: $
	        Next: transform
		transform:
			Type: Task
			Resource: arn:aws:states:::lambda:invoke
			OutputPath: $.Payload
			InputPath: $
			Parameters:
				FunctionName: '{{namespace}}_transformer_{{sandbox}}'
				Payload:
					data.$: $
	        Next: transform
		load:
			Type: Task
			Resource: arn:aws:states:::lambda:invoke
			OutputPath: $.Payload
			InputPath: $
			Parameters:
				FunctionName: '{{namespace}}_loader_{{sandbox}}'
				Payload:
					data.$: $
	        End: true
</code></pre>
<p>To update the flow do:</p>
<pre><code class="language-sh">tc update -s bob -e dev -c flow
</code></pre>
</li>
<li>
<p>To invoke the stepfunction flow:</p>
<pre><code class="language-sh">tc invoke -s bob -e dev --payload payload.json [--sync]
</code></pre>
</li>
<li>
<p>Finally, lets delete our dev sandbox and deploy this to a stable sandbox in upper envs</p>
<pre><code>tc delete -s bob -e dev
</code></pre>
</li>
</ol>
<h3 id="release-and-ci-workflow"><a class="header" href="#release-and-ci-workflow">Release and CI workflow</a></h3>
<p>Well, the above steps work well if we need to interactively build, test and try in our sandbox. Wouldn't it be nice to atomically create a sandbox and attach all the infrastructure components. Oh, while we are it, can we also version the topology ?</p>
<pre><code>tc deploy --sandbox stable --env qa --service etl --version 0.1.4
</code></pre>
<p>How do we bump the versions and <em>release</em> it to a QA env ? <code>tc</code> provides a simplified versioning scheme. The following command bumps the <em>minor</em> part of the semver and deploys to a QA sandbox</p>
<pre><code>tc release --service etl
;=&gt; 0.2.0
</code></pre>
<p>To see a meaningful changelog between releases:</p>
<pre><code>cd etl
tc diff --changelog
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../installation.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../examples/job-tracker.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../installation.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../examples/job-tracker.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../assets/mermaid.min.js"></script>
        <script src="../assets/mermaid-init.js"></script>


    </div>
    </body>
</html>
